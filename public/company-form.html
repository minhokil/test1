<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>전자 계약 시스템 - 기업 정보 입력</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 1em; display: flex; flex-direction: column; align-items: center; }
        .form-container { width: 80%; max-width: 900px; }
        #pdf-container { position: relative; border: 2px solid #333; margin-top: 1em; }
        #pdf-canvas { display: block; width: 100%; height: auto; }
        .input-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .input-field { position: absolute; box-sizing: border-box; border: 1px solid #007bff; background: rgba(0,123,255,0.1); font-size: 16px; }
        .seal-upload-area { position: absolute; box-sizing: border-box; border: 2px dashed #dc3545; background: rgba(220,53,69,0.1); display: flex; align-items: center; justify-content: center; text-align: center; font-size: 12px; color: #dc3545; }
        .seal-upload-area input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        button { margin-top: 1em; padding: 0.8em 1.2em; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="form-container">
        <h1>계약서 정보 입력 (기업 담당자용)</h1>
        <p>지정된 영역에 내용을 입력하고, 직인을 업로드한 후 제출해주세요.</p>

        <div id="pdf-container">
            <canvas id="pdf-canvas"></canvas>
            <form id="company-input-form" class="input-overlay"></form>
        </div>

        <button type="submit" form="company-input-form">내용 작성 및 제출</button>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

        const urlParams = new URLSearchParams(window.location.search);
        const contractId = urlParams.get('id');
        const form = document.getElementById('company-input-form');
        const pdfCanvas = document.getElementById('pdf-canvas');
        const pdfCtx = pdfCanvas.getContext('2d');
        let pdfScale = 1;

        // 계약 정보 로드 및 UI 생성
        fetch(`/api/contracts/${contractId}`)
            .then(res => res.json())
            .then(data => {
                if (!data.success) throw new Error(data.message);
                const contract = data.contract;
                const pdfUrl = `/uploads/${contract.current_pdf_name}`; // 항상 최신 PDF 사용

                return pdfjsLib.getDocument(pdfUrl).promise.then(pdf => {
                    return pdf.getPage(1).then(page => ({ page, contract }));
                });
            })
            .then(({ page, contract }) => {
                const viewport = page.getViewport({ scale: 1.5 });
                pdfScale = pdfCanvas.clientWidth / viewport.width;
                const scaledViewport = page.getViewport({ scale: pdfScale });

                pdfCanvas.height = scaledViewport.height;
                pdfCanvas.width = scaledViewport.width;

                page.render({ canvasContext: pdfCtx, viewport: scaledViewport });

                // 입력 필드 생성
                contract.fields.forEach(field => {
                    const el = createFieldElement(field, pdfScale);
                    form.appendChild(el);
                });
            })
            .catch(err => alert('오류: ' + err.message));

        function createFieldElement(field, scale) {
            const commonStyle = `position:absolute; left:${field.x * scale}px; top:${field.y * scale}px; width:${field.width * scale}px; height:${field.height * scale}px;`;

            if (field.type === 'text') {
                const input = document.createElement('textarea');
                input.name = `field_${field.id}`;
                input.className = 'input-field';
                input.style.cssText = commonStyle;
                return input;
            } else if (field.type === 'seal') {
                const div = document.createElement('div');
                div.className = 'seal-upload-area';
                div.style.cssText = commonStyle;
                div.innerHTML = `<span>직인 업로드</span><input type="file" name="field_${field.id}" accept="image/png, image/jpeg">`;
                return div;
            }
            return document.createElement('div'); // 다른 타입은 일단 빈 div
        }

        // 폼 제출
        form.addEventListener('submit', e => {
            e.preventDefault();
            const formData = new FormData(form);
            formData.append('contractId', contractId);

            fetch('/api/company-input', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('성공적으로 제출되었습니다. 학생/학부모에게 계약서가 전송됩니다.');
                    const signatureLink = `${window.location.origin}/signature-form.html?id=${contractId}`;
                    console.log(`[KAKAOTALK_SIMULATION] 학생/학부모에게 링크 전송: ${signatureLink}`);
                    alert(`학생/학부모용 링크 (콘솔 확인):\n${signatureLink}`);
                    window.location.href = '/admin.html';
                } else {
                    alert('제출 실패: ' + data.message);
                }
            });
        });
    </script>
</body>
</html>